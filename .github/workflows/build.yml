name: Build

on:
  push:
    branches: [ "main" ]
    paths-ignore: [ ".gitignore", "CODEOWNERS", "LICENSE", "*.md", "*.adoc", "*.txt", ".all-contributorsrc", ".github/project.yml" ]
  pull_request:
    paths-ignore: [ ".gitignore", "CODEOWNERS", "LICENSE", "*.md", "*.adoc", "*.txt", ".all-contributorsrc" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  build-linux:
    name: Build & test (Ubuntu with Ollama)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Restore Ollama models cache
        uses: actions/cache@v4
        with:
          path: ~/.ollama
          key: ${{ runner.os }}-ollama-${{ hashFiles('.github/ollama-models.txt') }}

      - name: Setup Ollama CLI
        uses: ai-action/setup-ollama@v1

      - name: Pre-pull models (tiny default)
        run: |
          # List the models in testsâ€”one per line
          xargs -n1 -I{} bash -c 'echo "Pulling {}"; ollama pull "{}"' < .github/ollama-models.txt

      - name: Build with Maven
        run: mvn -B clean install -Dno-format

  build-windows:
    name: Build only (Windows)
    runs-on: windows-latest
    steps:
      - name: Prepare git (CRLF)
        run: git config --global core.autocrlf false

      - uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build with Maven (skip agentic tests)
        run: mvn -B -Dno-format -DskipITs=true clean install
