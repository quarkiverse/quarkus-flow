= Secrets (via Quarkus CredentialsProvider)
:page-aliases: secrets/index.adoc
:sectnums:

Quarkus Flow integrates the CNCF Workflow Secrets concept with Quarkus’ `CredentialsProvider` SPI.
Workflows reference secrets by handle in the DSL (no cleartext), while Quarkus supplies the actual credentials from Vault/File Vault/custom providers at runtime.

== TL;DR

- Declare and reference secrets in the Java DSL (e.g., `use(u -> u.secrets("mySecret"))` and `${ $secret.mySecret.key }`).
- Provide a Quarkus `CredentialsProvider` bean (Vault, File Vault, or your own).
- Choose the provider globally or per secret using `@Named` bean names.
- If no provider exists, Quarkus Flow skips its bridge `SecretManager`; the SDK can fall back to a MicroProfile Config–based manager (dev-friendly).

== How resolution works

At runtime, Quarkus Flow provides a `SecretManager` that delegates to Quarkus `CredentialsProvider`:

1. Per-secret override:
`quarkus.flow.secrets.credentials-provider-names.<secret>=<beanName>`

2. Global default:
`quarkus.flow.secrets.credentials-provider-name=<beanName>`

3. Single provider present:
If exactly one `CredentialsProvider` bean exists, it is used.

4. Else fail fast:
If multiple exist with no selection, an error lists available `@Named` beans.

If no `CredentialsProvider` beans are present, Quarkus Flow does not bind its bridge `SecretManager`, allowing the SDK’s fallback (MicroProfile Config–backed manager) to take over.

[NOTE]
====
Typical keys expected from providers (see the link:https://github.com/serverlessworkflow/specification/blob/main/dsl-reference.md#authentication[specification types]):

**Basic auth**: username, password

**Bearer token**: token/access_token (lenient fallback to password)
Your HTTP executor maps these keys to the correct Authorization header when an authentication references a secret.
====

== Configuration

[source,properties]
----
#Global provider (by @Named bean)
quarkus.flow.secrets.credentials-provider-name=vault

# Per-secret provider overrides
quarkus.flow.secrets.credentials-provider-names.mySecret=file
quarkus.flow.secrets.credentials-provider-names.dbCreds=vault
----

[cols="2,3,5",options="header"]
|===
| Key | Example | Description

| quarkus.flow.secrets.credentials-provider-name
| vault
| Global @Named bean used for all secrets when not overridden.

| quarkus.flow.secrets.credentials-provider-names.<secret>
| mySecret=file
| Per-secret override: provider @Named used for the given secret handle.
|===

== Provide a CredentialsProvider

Use Quarkus Vault/File Vault or roll your own:

[source,java]
----
@ApplicationScoped
@Named("dumb")
public class DumbCredentialsProvider implements CredentialsProvider {
    @Override
    public Map<String, String> getCredentials(String name) {
        if ("mySecret".equals(name)) {
            return Map.of("key", "s3cr3t!");
        }
        return Map.of();
    }
}
----

== Java DSL examples

Declare the secret and consume it via the $secret expression:

[source,java]
----
@ApplicationScoped
public class SecretEchoFlow extends Flow {
    @Override
    public Workflow descriptor() {
        return workflow()
            .use(u -> u.secrets("mySecret")) // declare the handle
            .tasks(t -> t.set("${ $secret.mySecret.key }")) // -> "s3cr3t!"
            .build();
        }
    }
----

// Use a secret in an authentication (e.g., Basic) referenced by an HTTP task:
//
// [source,java]
// ----
// @ApplicationScoped
// public class CallWithBasicAuthFlow extends Flow {
//     @Override
//     public Workflow descriptor() {
//         return workflow().use(u -> {
//             u.secrets("usernamePasswordSecret");
//             u.authentications(a -> a.basic("basicFromSecret").use("usernamePasswordSecret"));
//         })
//         .tasks(d -> d.task("fetch")
//             .callHTTP(h -> h.get()
//                 .endpoint(e -> e.uri("https://secured.example.com")
//                 .authenticationUse("basicFromSecret"))))
//         .build();
//     }
// }
// ----
== Unit test example

[source,java]
----
@RegisterExtension
static final QuarkusUnitTest unit = new QuarkusUnitTest()
    .setArchiveProducer(() -> ShrinkWrap.create(JavaArchive.class)
    .addClass(SecretEchoFlow.class)
    .addClass(DumbCredentialsProvider.class))
    // select our @Named("dumb") provider globally
    .overrideConfigKey("quarkus.flow.secrets.credentials-provider-name", "dumb");

@Test
void resolves_secret_from_provider() {
    var handle = Arc.container().instance(WorkflowDefinition.class, Identifier.Literal.of(SecretEchoFlow.class.getName()));
    assertTrue(handle.isAvailable());

    var model = handle.get().instance().start().join();
    assertEquals("s3cr3t!", model.as(String.class).orElseThrow());
}
----

== Behavior & fallback

1. **Multiple providers, no selection** → error prompts to set global/per-secret selection and lists available names.
2. **Zero providers** → Quarkus Flow does not bind its bridge; SDK resolves via fallback (e.g., MicroProfile Config).
3. **Empty credential map** → clear error naming the provider and secret.

== Security notes

- Keep credentials out of the DSL—use handles only (e.g., "usernamePasswordSecret").
- Prefer real secret stores (Vault) in production; File Vault/custom providers are fine for dev/test.
- Quarkus Flow never logs secret values; errors include only provider/secret names.

== Troubleshooting

- _“CredentialsProvider @Named='X' not found”_: Ensure a bean exists with `@Named("X")`. The error lists available names.
- _Ambiguous providers_: Set `quarkus.flow.secrets.credentials-provider-name` or a per-secret override.
- _No credentials found for secret_: Verify your provider returns the expected keys for that secret handle.

== References

- Quarkus guide: link:https://quarkus.io/guides/credentials-provider[Using a Credentials Provider]
- CNCF Workflow Specification — Secrets: link:https://github.com/serverlessworkflow/specification/blob/main/dsl.md#secret[dsl.md#secret]
- CNCF Workflow Specification — Authentication: link:https://github.com/serverlessworkflow/specification/blob/main/dsl-reference.md#authentication[dsl-reference.md#authentication]
- Basic authentication reference: link:https://github.com/serverlessworkflow/specification/blob/main/dsl-reference.md#basic-authentication[basic-authentication]